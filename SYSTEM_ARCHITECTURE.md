# A股缠论实时交易系统 - 完整架构方案

## 系统概述

**目标**：基于缠论三类买卖点，实现从数据采集→分析研判→实时监控→交易信号的完整闭环

**核心特点**：
- 📊 技术分析驱动（图形学+动力学，不用新闻）
- ⚡ 实时监控（30f基线 → 5f精准 → 1f吃肉）
- 📧 邮件通知（带K线图、信号理由、建议价格）
- 🔒 稳定可靠（异常恢复、线程安全、容错重试）

---

## 系统架构流程

```
┌─────────────────────────────────────────────────────────┐
│ 第1阶段：数据采集与基线分析                              │
├─────────────────────────────────────────────────────────┤
│ 1. 初始化：过滤股票 (13999 → 5500 只)                  │
│    - 排除指数、ST、退市、停牌、僵尸股等                │
│    - 只保留正常交易的A股                                │
│                                                           │
│ 2. 采集30f：30天历史K线 (多线程，20个并发)             │
│    - 时间: ~5-10分钟 (5500股 ÷ 20线程)                │
│    - 输出：SQLite中的minute_bars_30f表                │
│                                                           │
│ 3. 实时分析30f：生成候选股清单                          │
│    - 计算每根K线的：笔、线段、中枢                      │
│    - 识别三类买卖点                                      │
│    - 输出：候选股列表 (预期300-500只)                  │
│    - 触发条件：买1/买2/买3 出现                        │
└─────────────────────────────────────────────────────────┘
          ↓
┌─────────────────────────────────────────────────────────┐
│ 第2阶段：5f精准监控                                     │
├─────────────────────────────────────────────────────────┤
│ 1. 初始化：只对候选股获取5f K线 (快速)                 │
│                                                           │
│ 2. 实时更新：每3-5分钟更新一次                          │
│    - 时间: 09:30-11:30, 13:00-15:00                   │
│    - 输出：SQLite中的minute_bars_5f表                 │
│                                                           │
│ 3. 实时分析5f：精准介入点                               │
│    - 在30f买点处，看5f的具体介入位置                   │
│    - 检查5f的笔/线段/中枢形成情况                      │
│    - 输出：交易预警（"准备介入"、"回调机会"）         │
└─────────────────────────────────────────────────────────┘
          ↓
┌─────────────────────────────────────────────────────────┐
│ 第3阶段：1f吃肉监控                                     │
├─────────────────────────────────────────────────────────┤
│ 1. 触发条件：5f确认介入信号                             │
│                                                           │
│ 2. 实时更新：每1分钟更新一次（高频）                    │
│    - 时间: 09:30-11:30, 13:00-15:00                   │
│    - 输出：SQLite中的minute_bars_1f表                 │
│                                                           │
│ 3. 精细分析1f：                                          │
│    - 1f买点确认 → 立即生成"买入信号"                  │
│    - 1f卖点出现 → 立即生成"卖出信号"                  │
│    - 包括：精确进场价格、止损位、止盈位                │
│                                                           │
│ 4. 邮件通知：发送信号到邮箱                             │
│    - K线图（带分型/中枢标记）                          │
│    - 信号理由（哪一类买卖点）                          │
│    - 建议价格和止损止盈                                │
│    - 时间戳和符号信息                                  │
└─────────────────────────────────────────────────────────┘
```

---

## 技术指标体系

### 缠论三类买卖点

**买点：**
- 买1：向上笔完成后形成底分型
- 买2：回踩中枢后再次上升触及新高
- 买3：中枢振荡中的底分型

**卖点：**
- 卖1：向下笔完成后形成顶分型
- 卖2：反弹中枢后再次下跌触及新低
- 卖3：中枢振荡中的顶分型

### 数据维度

| 维度 | 周期 | 用途 | 更新频率 |
|-----|------|------|--------|
| 30f | 30分钟 | 判断主趋势 | 采集一次 |
| 5f | 5分钟 | 精准介入 | 每3-5分钟 |
| 1f | 1分钟 | 吃肉点位 | 每1分钟 |

---

## 模块划分

### 1. 数据层（data_layer）

```python
SmartStockFilter          # 智能过滤 (13999 → 5500)
MultiTimeframeDataFetcher # 多时间框架采集
├── fetch_30f_baseline()      # 基线：采集30f全部股票
├── fetch_5f_watchlist()      # 精准：采集候选5f
└── fetch_1f_realtime()       # 高频：采集入场后1f
```

### 2. 分析层（analysis_layer）

```python
ChanTheoryAnalyzer        # 缠论分析引擎
├── detect_strokes()      # 笔检测
├── detect_segments()     # 线段检测
├── detect_centers()      # 中枢检测
├── identify_fractals()   # 分型识别
└── classify_signals()    # 三类买卖点分类
```

### 3. 监控层（monitoring_layer）

```python
RealtimeMonitor           # 实时监控器
├── monitor_30f()         # 30f候选股筛选
├── monitor_5f()          # 5f精准信号 (每3-5分钟)
└── monitor_1f()          # 1f吃肉点位 (每1分钟)
```

### 4. 通知层（notification_layer）

```python
EmailNotifier             # 邮件通知
├── generate_chart()      # 生成K线图（带标记）
├── compose_signal()      # 组织信号内容
└── send_email()          # 发送邮件
```

---

## 实现计划

### Phase 1: 数据采集优化 (已完成)
- ✅ 多线程并发 (15线程)
- ✅ 智能股票过滤 (13999 → 5500)
- ✅ 错误处理增强

### Phase 2: 缠论分析完善 (进行中)
- 🔲 笔检测算法改进
- 🔲 线段识别准确度
- 🔲 中枢判断逻辑
- 🔲 三类买卖点明确定义

### Phase 3: 实时监控系统 (计划中)
- 🔲 30f基线分析 (采集完成后立即运行)
- 🔲 5f精准监控 (每3-5分钟检查候选股)
- 🔲 1f高频监控 (入场后每1分钟检查)
- 🔲 信号去重和合并

### Phase 4: 邮件通知系统 (计划中)
- 🔲 K线图生成器 (带分型/中枢/买卖点标记)
- 🔲 HTML邮件模板
- 🔲 多账户邮件配置
- 🔲 邮件历史记录

### Phase 5: 性能优化 (计划中)
- 🔲 数据库索引优化
- 🔲 缓存机制 (减少重复计算)
- 🔲 异常恢复机制
- 🔲 资源占用监控

---

## 配置示例

```yaml
# config.yaml
system:
  mode: production  # production / test
  log_level: INFO
  timezone: Asia/Shanghai

data_collection:
  timeframes: [30, 5, 1]        # 采集三个时间框架
  history_days: 30               # 30天历史K线
  threads:
    baseline: 20                 # 30f基线采集20线程
    watchlist: 5                 # 5f采集5线程
    realtime: 2                  # 1f采集2线程

analysis:
  min_volume: 100000             # 最小成交量过滤
  st_excluded: true              # 排除ST股
  min_price: 0.5                 # 最小股价

monitoring:
  baseline_interval: 3600        # 30f每小时检查一次
  watchlist_interval: 300        # 5f每5分钟检查一次
  realtime_interval: 60          # 1f每1分钟检查一次
  market_open: "09:30"
  market_close: "15:00"

notification:
  email_enabled: true
  smtp_server: smtp.163.com
  from_email: your-email@163.com
  to_emails:
    - trader@example.com
    - admin@example.com
  
  signal_types:
    - buy1
    - buy2
    - sell1
    - sell2
```

---

## 核心指标计算

### 笔的判断
```
向上笔：底1 < 底2 < 底3，且中间有顶
向下笔：顶1 > 顶2 > 顶3，且中间有底
```

### 线段的判断
```
向上线段：笔1上升 + 笔2下降 + 笔3上升，
          且笔1的顶 > 笔2的顶，笔3的顶 > 笔1的顶
```

### 中枢的判断
```
3根K线形成中枢高点和中枢低点
后续K线与中枢的关系：
- 完全高于中枢 → 中枢上破
- 完全低于中枢 → 中枢下破
- 与中枢相交 → 中枢震荡
```

### 分型的判断
```
顶分型：中(k) > 中(k-1) 且 中(k) > 中(k+1)
底分型：中(k) < 中(k-1) 且 中(k) < 中(k+1)
```

---

## 时间规划

| 阶段 | 任务 | 预期时间 | 优先级 |
|-----|------|--------|------|
| 1 | 采集30f基线 | 采集后立即 | P0 |
| 2 | 生成候选清单 | <1分钟 | P0 |
| 3 | 采集候选5f | 5分钟内 | P1 |
| 4 | 5f信号识别 | 15分钟内 | P1 |
| 5 | 采集1f监控 | 入场后 | P1 |
| 6 | 1f高频监控 | 实时 | P1 |
| 7 | 邮件通知 | 信号产生时 | P2 |

---

## 预期效果

✅ **稳定性**
- 不崩溃的错误处理
- 自动异常恢复
- 完整日志记录

✅ **性能**
- 30f采集: 5-10分钟
- 5f采集: 1-2分钟
- 1f采集: 实时（<1秒）

✅ **准确性**
- 缠论框架完整
- 三类买卖点清晰
- 信号去重有效

✅ **易用性**
- 邮件即时提醒
- 图表直观展示
- 行动建议明确

---

## 下一步行动

1. **立即运行诊断**
   ```bash
   python3 smart_stock_filter.py
   python3 diagnose_api_issues.py
   ```

2. **更新multi_timeframe_fetcher.py**
   - 集成SmartStockFilter
   - 改进缠论分析算法

3. **实现邮件通知**
   - K线图生成
   - HTML模板
   - SMTP配置

4. **部署监控系统**
   - 定时任务
   - 实时队列
   - 信号管理

---

## 关键成功因素

| 因素 | 方案 |
|-----|------|
| 稳定性 | 多层异常处理 + 自动恢复 |
| 性能 | 多线程 + 缓存 + 数据库索引 |
| 准确性 | 缠论算法验证 + 历史回测 |
| 及时性 | 实时监控 + 邮件推送 |
| 可维护性 | 清晰的模块划分 + 完整文档 |
