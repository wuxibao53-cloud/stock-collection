name: stock-collect

on:
  schedule:
    - cron: '0 0 * * 1-5'
  workflow_dispatch:
    inputs:
      mode:
        description: 'é‡‡é›†æ¨¡å¼'
        required: false
        default: 'hot'
        type: choice
        options:
          - hot
          - incremental
          - all

jobs:
  run:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      HTTP_PROXY: ${{ secrets.HTTP_PROXY }}
      HTTPS_PROXY: ${{ secrets.HTTPS_PROXY }}
      FORCE_UA: ${{ secrets.FORCE_UA }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      - run: pip install -r requirements.txt
      - run: mkdir -p logs
      - name: Test data source
        run: |
          echo "Testing Sina API..."
          curl -s 'https://hq.sinajs.cn/list=sh000001,sz000001' | head -n 2 || echo "API test skipped"
      - run: python3 -c "import sqlite3;c=sqlite3.connect('logs/quotes.db');c.cursor().execute('CREATE TABLE IF NOT EXISTS minute_bars(id INTEGER PRIMARY KEY,symbol TEXT,minute TEXT,open REAL,high REAL,low REAL,close REAL,volume INTEGER,amount REAL,UNIQUE(symbol,minute))');c.commit();c.close()"
      - name: Run async collector
        run: |
          MODE="${{ github.event.inputs.mode || 'incremental' }}"
          echo "é‡‡é›†æ¨¡å¼: $MODE"
          python3 full_a_stock_collector.py --db logs/quotes.db --mode "$MODE" --async 2>&1 | tee logs/collector.log || true
      - name: Show collector output
        run: tail -n 100 logs/collector.log || true
      - name: Verify data
        run: |
          python3 -c "import sqlite3,os;db='logs/quotes.db';c=sqlite3.connect(db);r=c.cursor().execute('SELECT COUNT(*) FROM minute_bars').fetchone();count=r[0];print(f'âœ“ é‡‡é›†æˆåŠŸ: {count} æ¡è®°å½•');c.close();exit(0 if count > 10 else 1)" || echo "é‡‡é›†æ•°æ®ä¸è¶³"
      - name: Generate report
        if: always()
        run: |
          python3 -c "
          import sqlite3
          db = 'logs/quotes.db'
          c = sqlite3.connect(db)
          cursor = c.cursor()
          cursor.execute('SELECT symbol, COUNT(*) as cnt FROM minute_bars GROUP BY symbol ORDER BY cnt DESC LIMIT 10')
          print('\nğŸ“ˆ Top 10 é‡‡é›†æœ€å¤š:')
          for symbol, cnt in cursor.fetchall():
              print(f'  {symbol:10} {cnt:6} æ¡')
          c.close()
          " || true
