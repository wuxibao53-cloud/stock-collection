name: å•è‚¡å¿«é€ŸæŸ¥è¯¢

on:
  workflow_dispatch:
    inputs:
      symbol:
        description: 'è‚¡ç¥¨ä»£ç ï¼ˆå¦‚ï¼šsh600519ï¼‰'
        required: true
        type: string
      days:
        description: 'åŽ†å²å¤©æ•°'
        required: false
        default: '5'
        type: string
      timeframes:
        description: 'æ—¶é—´æ¡†æž¶ï¼ˆç©ºæ ¼åˆ†éš”ï¼Œå¦‚ï¼š1 5 30ï¼‰'
        required: false
        default: '1 5 30'
        type: string

jobs:
  quick-fetch:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    
    steps:
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
      
      - name: è®¾ç½®PythonçŽ¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'
      
      - name: å®‰è£…ä¾èµ–
        run: |
          pip install --upgrade pip
          pip install akshare pandas schedule || true
      
      - name: åˆ›å»ºæ—¥å¿—ç›®å½•
        run: mkdir -p logs
      
      - name: èŽ·å–å•è‚¡æ•°æ®
        run: |
          SYMBOL="${{ github.event.inputs.symbol }}"
          DAYS="${{ github.event.inputs.days || '5' }}"
          TF="${{ github.event.inputs.timeframes || '1 5 30' }}"
          echo "ðŸ“Š èŽ·å– ${SYMBOL} æœ€è¿‘ ${DAYS} å¤©æ•°æ®ï¼ˆæ—¶é—´æ¡†æž¶: ${TF}ï¼‰..."
          python3 multi_timeframe_fetcher.py --db logs/quotes.db --symbol ${SYMBOL} --days ${DAYS} --timeframes ${TF} 2>&1 | tee logs/single_stock.log
      
      - name: åˆ†åž‹æ£€æµ‹
        run: |
          SYMBOL="${{ github.event.inputs.symbol }}"
          python3 << 'EOF'
          import sys
          from multi_timeframe_fetcher import MultiTimeframeDataFetcher, TimeFrame
          
          symbol = '${{ github.event.inputs.symbol }}'
          fetcher = MultiTimeframeDataFetcher('logs/quotes.db')
          
          print(f"\n{'='*60}")
          print(f"åˆ†åž‹æ£€æµ‹ç»“æžœï¼š{symbol}")
          print('='*60)
          
          for tf in [TimeFrame.THIRTY_MIN, TimeFrame.FIVE_MIN, TimeFrame.ONE_MIN]:
              fractals = fetcher.detect_fractal_patterns(symbol, tf)
              print(f"\n{tf.value}f åˆ†åž‹ï¼š{len(fractals)} ä¸ª")
              for f in fractals[-3:]:  # æœ€è¿‘3ä¸ª
                  print(f"  {f['type']:6} | {f['time']} | ä»·ä½ {f['level']:.2f}")
          EOF
      
      - name: ä¸Šä¼ äº§ç‰©
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: single-stock-${{ github.event.inputs.symbol }}-${{ github.run_number }}
          path: |
            logs/*.log
            logs/quotes.db
          retention-days: 7
