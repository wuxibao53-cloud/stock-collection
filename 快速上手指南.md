# 🚀 缠论系统 - 快速上手指南（5步搞定）

## 📋 配置前准备

你需要：
- ✅ 钉钉账号（已下载）
- ✅ GitHub 账号
- ✅ 约 15 分钟时间

---

## 第一步：创建钉钉群机器人（3 分钟）

### 1.1 创建钉钉群

1. **打开钉钉 App**
2. **点击右上角 "+"**
3. **选择 "发起群聊"**
4. **选择 "内部群"**
5. **群名称输入**：`缠论交易系统告警`
6. **添加自己**，点击 "确定"

### 1.2 添加群机器人

1. **进入刚创建的群**
2. **点击右上角 "..." (更多)**
3. **选择 "群设置"**
4. **下滑找到 "智能群助手"**
5. **点击 "添加机器人"**
6. **选择 "自定义" 机器人**（通过 Webhook 接入）

### 1.3 配置机器人

在"添加机器人"页面：

1. **机器人名字**：`Chan Trading Alert`
2. **安全设置**（选其一）：
   
   **方式 A（推荐）**：自定义关键词
   - ✅ 勾选 "自定义关键词"
   - 输入关键词：`缠论` 或 `采集`
   
   **方式 B**：加签（更安全但复杂）
   - 如果选择这个，需要记录 Secret 值
   - 暂时用方式 A 即可

3. **勾选**：我已阅读并同意...
4. **点击 "完成"**

### 1.4 复制 Webhook URL

**重要！** 机器人创建成功后会显示 Webhook 地址：

```
https://oapi.dingtalk.com/robot/send?access_token=xxxxxxxxxxxxx
```

**立即复制这个完整 URL！** 我们马上要用到。

如果不小心关闭了：
- 群设置 → 智能群助手 → 点击机器人名称 → 查看 Webhook

---

## 第二步：本地测试钉钉连接（2 分钟）

现在测试一下钉钉能否正常收到消息。

### 2.1 在终端运行

```bash
# 进入项目目录
cd /Users/lihaoran/Desktop/stock_collection

# 设置 Webhook（替换成你的真实 URL）
export DINGTALK_WEBHOOK="https://oapi.dingtalk.com/robot/send?access_token=你的token"

# 测试发送消息
python github_secrets_config.py --test-dingtalk "$DINGTALK_WEBHOOK"
```

### 2.2 检查结果

你应该在钉钉群里看到类似这样的消息：

```
✅ 缠论交易系统告警测试成功
时间: 2026-01-20 14:30:00
源: GitHub Actions
状态: 连接正常 🎉
```

**如果收到消息** → ✅ 继续下一步
**如果没收到** → 检查：
1. Webhook URL 是否完整复制？
2. 安全设置关键词是否包含"缠论"或"采集"？
3. 网络是否正常？

---

## 第三步：配置 GitHub Secrets（2 分钟）

### 3.1 进入 GitHub 仓库

打开浏览器，访问：
```
https://github.com/wuxibao53-cloud/stock-collection/settings/secrets/actions
```

### 3.2 添加 Secret

1. **点击右上角绿色按钮**：`New repository secret`

2. **填写信息**：
   - **Name（名称）**：`DINGTALK_WEBHOOK`
   - **Secret（值）**：粘贴你刚才复制的完整 Webhook URL
   
3. **点击**：`Add secret`

### 3.3 验证

返回 Secrets 页面，应该能看到：
- `DINGTALK_WEBHOOK` ✅

---

## 第四步：手动触发工作流测试（3 分钟）

### 4.1 进入 Actions 页面

访问：
```
https://github.com/wuxibao53-cloud/stock-collection/actions
```

### 4.2 找到工作流

左侧列表找到：
```
缠论交易系统 - 云端自动执行
```
点击进入

### 4.3 手动运行

1. **点击右侧按钮**：`Run workflow`
2. **选择**：
   - Use workflow from: `Branch: main`
   - 执行模式: `alert` （先测试告警功能）
3. **点击绿色按钮**：`Run workflow`

### 4.4 监控进度

页面会自动刷新，显示工作流运行状态：

```
🟡 缠论交易系统 - 云端自动执行
   ├─ 🟡 market-collection (运行中...)
   ├─ ⏸ data-aggregation (等待中)
   └─ ⏸ monitoring-alerts (等待中)
```

点击 `market-collection` 可以查看实时日志。

### 4.5 等待完成（约 2-3 分钟）

当看到全部变成绿色 ✅ 时：

```
✅ 缠论交易系统 - 云端自动执行
   ├─ ✅ market-collection
   ├─ ✅ data-aggregation
   └─ ✅ monitoring-alerts
```

**同时钉钉群应该收到详细的采集报告！**

---

## 第五步：验证数据采集（5 分钟）

### 5.1 下载采集结果

1. **在工作流完成页面**，下滑找到 `Artifacts`
2. **点击下载**：`final-database`
3. **解压缩**得到 `quotes.db`
4. **移动到项目目录**：
   ```bash
   mv ~/Downloads/quotes.db /Users/lihaoran/Desktop/stock_collection/logs/
   ```

### 5.2 验证数据质量

```bash
cd /Users/lihaoran/Desktop/stock_collection

# 查看采集摘要
python verify_collection.py --db logs/quotes.db

# 生成详细报告
python verify_collection.py --db logs/quotes.db \
  --generate-report \
  --output collection_report.html

# 打开报告查看
open collection_report.html
```

### 5.3 检查采集结果

终端应该显示类似：

```
══════════════════════════════════════════════════
📊 缠论交易系统 - 采集验证摘要
══════════════════════════════════════════════════

📈 基本统计:
  • 采集股票数: 100 只  (热门模式)
  • 采集数据条数: 5,000 条
  • 平均每股: 50 条
  • 数据跨度: 2026-01-20 09:30 to 2026-01-20 15:00

🏙️ 市场分布:
  • 上证: 45 只股票, 2250 条数据
  • 深证: 55 只股票, 2750 条数据

🔍 数据质量:
  • 缺失价格: 0 条
  • 缺失成交量: 0 条
  • 异常价格: 0 条
  • 重复记录: 0 条

✅ 验证结果:
  • 数据质量 (>99%): 100.0% ✓ PASS
```

---

## 🎉 恭喜！配置完成！

现在你的系统已经：
- ✅ 钉钉通知正常工作
- ✅ GitHub Actions 云端自动运行
- ✅ 数据采集成功
- ✅ 质量验证通过

---

## 📊 后续操作

### 自动定时执行

工作流会在以下时间**自动运行**（无需手动）：

| 时间 | 说明 | 北京时间 |
|------|------|---------|
| 每天 08:00 | 开盘前准备 | 08:00 |
| 每天 09:35 | 开盘后采集 | 09:35 |
| 每天 11:35 | 午盘收集 | 11:35 |
| 每天 15:05 | 收盘后统计 | 15:05 |

每次运行完成后，钉钉都会收到通知！

### 查看历史运行

访问：
```
https://github.com/wuxibao53-cloud/stock_collection/actions
```

可以看到所有运行记录、日志和下载数据。

### 修改采集模式

如果想采集全部 5000+ 只股票：

1. 进入 Actions
2. Run workflow
3. 执行模式选择：`full` （完整模式）

⚠️ 注意：完整模式耗时较长（约 10-15 分钟）

---

## 💰 成本说明

### GitHub Actions 免费额度

免费账户每月：
- ✅ 2000 分钟运行时间
- ✅ 500MB 存储空间

我们的使用：
- 每次运行：约 3-5 分钟
- 每天 4 次：12-20 分钟
- 每月：360-600 分钟

**完全在免费额度内！** 👍

### 钉钉群机器人

- ✅ 完全免费
- ✅ 无消息数量限制
- ✅ 无使用时长限制

**总成本：¥0** 🎉

---

## 🐛 常见问题

### Q1: 钉钉没收到消息？

检查：
1. Webhook URL 是否正确？
2. 安全设置关键词是否包含"缠论"？
3. 消息内容是否包含关键词？

解决：
```bash
# 重新测试
python github_secrets_config.py --test-dingtalk "$DINGTALK_WEBHOOK"
```

### Q2: 工作流运行失败？

查看：
1. GitHub Actions 日志（点击失败的步骤）
2. 是否是网络问题（Sina API 限流）

解决：
- 重新运行：点击 "Re-run all jobs"
- 或稍后再试

### Q3: 数据采集为空？

原因：
- 可能是非交易时间
- 或者网络问题

解决：
- 在交易时间（9:30-15:00）重新运行
- 检查日志中的错误信息

---

## 📞 需要帮助？

遇到问题随时提问！可以：

1. **查看详细文档**：
   - GITHUB_SECRETS_SETUP.md
   - CLOUD_WORKFLOW_TEST.md

2. **查看工作流日志**：
   - GitHub Actions 页面
   - 点击具体步骤查看详细输出

3. **提交 Issue**：
   - https://github.com/wuxibao53-cloud/stock-collection/issues

---

## 🎯 下一步

完成配置后，可以：

1. **添加企业微信通知**（可选）
   - 类似钉钉的步骤
   - 创建 `WECHAT_WEBHOOK` Secret

2. **运行完整采集**
   - 执行模式选 `full`
   - 采集 5000+ 只股票

3. **进入 P2 阶段**
   - 策略回测验证
   - 参数优化
   - 监控仪表板

---

**准备好了吗？开始第一步吧！** 💪

有任何问题随时问我！
